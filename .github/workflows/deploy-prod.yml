name: Release to Production

on:
  push:
    tags:
      - 'v*'

jobs:
  changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-22.04
    outputs:
      client: ${{ steps.filter.outputs.client }}
      server: ${{ steps.filter.outputs.server }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          base: ${{ github.event.before }}
          filters: |
            client:
              - 'client/**'
            server:
              - 'server/**'

  test:
    name: ðŸ§ª Run tests
    needs: changes
    if: ${{ fromJSON(needs.changes.outputs.server) }}
    runs-on: ubuntu-22.04
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: sc-planner-db-test
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Load test environment variables
        run: |
          cd server
          if [ -f .env.test ]; then
            export $(cat .env.test | grep -v '^#' | xargs)
            cat .env.test | grep -v '^#' >> $GITHUB_ENV
          fi

      - name: Install server dependencies
        run: |
          cd server
          npm install

      - name: Run unit tests
        run: |
          cd server
          npm run test

  build-and-deploy:
    name: ðŸš€ Build & Deploy Production
    needs: [changes, test]
    if: ${{ (fromJSON(needs.changes.outputs.client) || fromJSON(needs.changes.outputs.server)) && (needs.changes.outputs.server == 'false' || success()) }}
    runs-on: ubuntu-22.04

    env:
      VERSION_TAG: ${{ github.ref_name }}
      REGISTRY: docker.io
      IMAGE_PREFIX: thoomaas123/sc-planner

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸ› ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: ðŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Build & Push Client Image
        if: ${{ fromJSON(needs.changes.outputs.client) }}
        uses: docker/build-push-action@v6
        with:
          context: ./client
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-client:${{ env.VERSION_TAG }}
            ${{ env.IMAGE_PREFIX }}-client:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: ðŸ—ï¸ Build & Push Server Image
        if: ${{ fromJSON(needs.changes.outputs.server) }}
        uses: docker/build-push-action@v6
        with:
          context: ./server
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-server:${{ env.VERSION_TAG }}
            ${{ env.IMAGE_PREFIX }}-server:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: ðŸ“ Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ env.VERSION_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Client Image**: \`${{ env.IMAGE_PREFIX }}-client:${{ env.VERSION_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Server Image**: \`${{ env.IMAGE_PREFIX }}-server:${{ env.VERSION_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Images pushed successfully" >> $GITHUB_STEP_SUMMARY

      # ðŸ”’ DÃ©ploiement SSH dÃ©sactivÃ© pour lâ€™instant
            # - name: ðŸš€ Deploy to Production Server
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.PROD_HOST }}
      #     username: ${{ secrets.PROD_USERNAME }}
      #     key: ${{ secrets.PROD_SSH_KEY }}
      #     port: 22
      #     script: |
      #       cd /var/www/vhosts/thomasfourties.fr/sc-planner.thomasfourties.fr
      #       docker-compose -f docker-compose.prod.yml down
      #       git fetch --tags
      #       git checkout ${{ env.VERSION_TAG }}
      #       export TAG=${{ env.VERSION_TAG }}
      #       sed -i "s|image: thoomaas123/sc-planner-client:.*|image: thoomaas123/sc-planner-client:$TAG|" docker-compose.prod.yml
      #       sed -i "s|image: thoomaas123/sc-planner-server:.*|image: thoomaas123/sc-planner-server:$TAG|" docker-compose.prod.yml
      #       docker-compose -f docker-compose.prod.yml pull
      #       docker-compose -f docker-compose.prod.yml up -d --remove-orphans
      #       docker image prune -f
      #       docker system prune -f
